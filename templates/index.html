<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/static/input.js" type="text/javascript"></script>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
		.center {
			margin: auto;
			width: 100%;
		}

        .message {
            padding: 10px;
            margin: 5px;
            background-color: #FFFFFF
        }

        table, th, td {
            margin: 5px;
            padding: 5px;
            text-align: center;
            max-width: 700px;
            word-wrap: break-word;
        }

		.tabl th, .tabl td, .tabl tr {
            margin: 5px;
            padding: 5px;
            text-align: center;
            max-width: 700px;
            word-wrap: break-word;
			border: 1px solid white;
			border-collapse: collapse;
			flex: 1;
            overflow-y: auto;  /* Enables vertical scrolling */
            padding: 10px;
        }

        .tabl tr:hover {
            background-color: lightgreen;
        }

        input.button {
            width: 100%;  
            height: 2em;
            font-weight: bold;
            border-radius: 4px;
            transition-duration: 0.4s;
        }

	    input.button:hover {
            background-color: tomato;
            color: white;
	    }

        /* Container to hold both the fixed header and scrollable table */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;  /* Full viewport height */
        }

        /* Fixed header */
        .header {
            padding: 10px;
            text-align: center;
            font-size: 24px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: powderblue;
            z-index: 10; /* Ensure it's above the table */
        }

        #table-container {
            margin-top: 250px;
            overflow-y: auto;
            flex: 1;
        }

    </style>

	<body style="background-color:powderblue; overflow: hidden;">

		<div class="container">
			<div class="header">
				<table class="center">
					<tr>
						<td><input type="button" name="vocal" value="vocal" class="button" onclick="buttonEvent({'cmd':'vocal','param':''})"></td>
						<td><input type="button" name="repeat" value="repeat" class="button" onclick="buttonEvent({'cmd':'repeat','param':''})"></td>
						<td><input type="button" name="stop" value="stop" class="button" onclick="buttonEvent({'cmd':'stop','param':''})"></td>
						<td><input type="button" name="stop" value="pause" class="button" onclick="buttonEvent({'cmd':'pause','param':''})"></td>
					</tr>
				</table>
				<table class="center">
					<tr>
					<td><textarea name="content" style="font-size:12pt; width:100%; height:80px;" id="textbox" placeholder="Paste YouTube link here" enablePaste()></textarea></td>
					</tr>
				</table>
				<table class="center">
					<tr>
						<td><input type="button" name="add" value="add" class="button" onclick="handleAddButton()"></td>
						<td><input type="button" name="delete" value="delete" class="button" onclick="handleDeleteButton()"></td>
						<td><input type="button" name="jump" value="jump" class="button" onclick="handleJumpButton()"></td>
					</tr>
				</table>		
    		</div>

	 		<div id="table-container">

        			{% include 'table.html' %}

    		</div>
		</div>

		<script>
			function getInput()
			{
				var data = document.getElementById('textbox').value;
				document.getElementById('textbox').value = '';
				return data;
			}

			let currentHoveredRow = null;

			async function handleAddButton() {
				var textbox = document.getElementById('textbox');

				if(textbox.value.startsWith('http://') || textbox.value.startsWith('https://') || textbox.value.trim() !== '')
				{
					buttonEvent({'cmd':'add','param': getInput()});
				}
				
				// Check if a row is being hovered and copy its index
				else if (currentHoveredRow && currentHoveredRow.cells[0] && currentHoveredRow.cells[0].textContent[0] == '-') {
					textbox.value = currentHoveredRow.cells[0].textContent;
					buttonEvent({'cmd':'add','param': getInput()});
				}

				refreshTable();
				
			}

			function enablePaste() {
				var inputField = document.getElementById('textbox');
				inputField.setSelectionRange(inputField.value.length, inputField.value.length); // Focus the input
			}

			// Establish an SSE connection to the Flask server
			const eventSource = new EventSource('/stream');

			function refreshTable() {
				const container = document.getElementById('table-container');
				const scrollTop = container.scrollTop;
				
				fetch('/get_table')
					.then(response => response.text())
					.then(html => {
						container.innerHTML = html;
						container.scrollTop = scrollTop;
						addRowHoverListeners();
					});
			}

			// Event handler for when new data is received from the server
			eventSource.onmessage = function(event) {
				if (event.data === 'refresh') {
					refreshTable();
				}
			};

			function handleDeleteButton() {
				var textbox = document.getElementById('textbox');
				if (currentHoveredRow && currentHoveredRow.cells[0] && currentHoveredRow.cells[0].textContent !== '') {
					textbox.value = currentHoveredRow.cells[0].textContent;
					
					buttonEvent({'cmd':'delete','param': getInput()});
					refreshTable();
				}
				
			}

			function handleJumpButton() {
				var textbox = document.getElementById('textbox');
				if (currentHoveredRow && currentHoveredRow.cells[0] && currentHoveredRow.cells[0].textContent !== '') {
					textbox.value = currentHoveredRow.cells[0].textContent;

					buttonEvent({'cmd':'jump','param': getInput()});
					refreshTable();
				}
				
			}

			function addRowHoverListeners() {
				const rows = document.querySelectorAll('.tabl tr');
				const deleteBtn = document.querySelector('input[name="delete"]');
				const jumpBtn = document.querySelector('input[name="jump"]');
				const addBtn = document.querySelector('input[name="add"]');
				
				rows.forEach(row => {
					row.addEventListener('mouseenter', function() {
						currentHoveredRow = this;
						const indexCell = this.cells[0];
						const index = parseInt(indexCell.textContent);
						if (indexCell && index < 0) {
							//deleteBtn.disabled = true;
							jumpBtn.disabled = true;
						}
					});
					row.addEventListener('mouseleave', function() {
						deleteBtn.disabled = false;
						jumpBtn.disabled = false;
						addBtn.disabled = false;
					});
				});
			}

			// Initialize on page load
			addRowHoverListeners();

			// Automatic refresh every 10 seconds
			setInterval(refreshTable, 10000);
		</script>

</body>
</html>
